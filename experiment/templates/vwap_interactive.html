<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive VWAP Chart - {{ config.symbol }} {{ config.target_timeframe }}</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #0d1117;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #21262d;
            padding-bottom: 15px;
        }
        
        .header h1 {
            color: #58a6ff;
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #161b22;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #21262d;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            width: 12px;
            height: 12px;
            background: #3fb950;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .config-card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: border-color 0.3s;
        }
        
        .config-card:hover {
            border-color: #58a6ff;
        }
        
        .config-label {
            color: #8b949e;
            font-size: 0.85em;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .config-value {
            color: #58a6ff;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .chart-container {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #238636, #2ea043);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #2ea043, #238636);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #21262d, #30363d);
            border: 1px solid #21262d;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #30363d, #21262d);
            border-color: #58a6ff;
        }
        
        .info-panel {
            background: #0d1117;
            border: 1px solid #21262d;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .update-status {
            color: #3fb950;
            font-weight: 600;
        }
        
        .error {
            color: #f85149;
            background: #161b22;
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        
        #chart {
            width: 100%;
            height: 800px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: #8b949e;
            font-size: 1.2em;
        }
        
        .spinner {
            border: 3px solid #21262d;
            border-top: 3px solid #58a6ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Interactive VWAP Chart</h1>
        <p>Real-time {{ config.symbol }} analysis with instant file watching</p>
    </div>
    
    <div class="status-bar">
        <div class="status-item">
            <div class="live-indicator"></div>
            <strong>LIVE</strong> - File watching enabled
        </div>
        <div class="status-item">
            <strong>Candles:</strong> <span id="candleCount">{{ candle_count }}</span>
        </div>
        <div class="status-item">
            <strong>Last Update:</strong> <span id="lastUpdate">Loading...</span>
        </div>
    </div>
    
    <div class="config-grid">
        <div class="config-card">
            <div class="config-label">Symbol</div>
            <div class="config-value">{{ config.symbol }}</div>
        </div>
        <div class="config-card">
            <div class="config-label">Timeframe</div>
            <div class="config-value">{{ config.target_timeframe }}</div>
        </div>
        <div class="config-card">
            <div class="config-label">VWAP Period</div>
            <div class="config-value">{{ config.vwap_length }}</div>
        </div>
        <div class="config-card">
            <div class="config-label">Band Period</div>
            <div class="config-value">{{ config.band_length }}</div>
        </div>
        <div class="config-card">
            <div class="config-label">RSI Period</div>
            <div class="config-value">{{ config.rsi_length }}</div>
        </div>
        <div class="config-card">
            <div class="config-label">Max Candles</div>
            <div class="config-value">{{ config.max_candles }}</div>
        </div>
    </div>
    
    <div class="chart-container">
        <div id="chart">
            <div class="loading">
                <div class="spinner"></div>
                Loading interactive chart...
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button class="btn" onclick="refreshChart()">Refresh Chart</button>
        <button class="btn btn-secondary" onclick="toggleAutoUpdate()" id="autoUpdateBtn">Disable Auto-Update</button>
    </div>
    
    <div class="info-panel">
        <div class="update-status">
            âœ¨ Chart updates instantly when you modify config or data files
        </div>
        <p style="color: #8b949e; margin: 10px 0 0 0; font-size: 0.9em;">
            Interactive features: Zoom, Pan, Hover for details, Click legend to toggle series
        </p>
    </div>

    <script>
        let autoUpdateEnabled = true;
        let eventSource = null;
        
        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        function loadChart() {
            fetch('/api/chart')
                .then(response => response.json())
                .then(data => {
                    if (data.chart) {
                        // Configure Plotly with trading-optimized settings
                        const config = {
                            responsive: true,
                            displayModeBar: true,
                            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d'],
                            modeBarButtonsToAdd: ['drawline', 'drawopenpath', 'drawclosedpath'],
                            scrollZoom: true,
                            doubleClick: 'reset+autosize'
                        };
                        
                        Plotly.newPlot('chart', data.chart.data, data.chart.layout, config);
                        
                        document.getElementById('candleCount').textContent = data.candle_count;
                        updateTimestamp();
                        console.log('Chart loaded:', new Date().toLocaleTimeString());
                    }
                })
                .catch(error => {
                    console.error('Error loading chart:', error);
                    document.getElementById('chart').innerHTML = 
                        '<div class="error"><h3>Chart Loading Error</h3><p>Unable to load chart data. Check console for details.</p></div>';
                });
        }
        
        function refreshChart() {
            document.getElementById('chart').innerHTML = 
                '<div class="loading"><div class="spinner"></div>Refreshing chart...</div>';
            loadChart();
        }
        
        function startEventSource() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/events');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.reload && autoUpdateEnabled) {
                    console.log('File change detected, updating chart...');
                    refreshChart();
                }
            };
            
            eventSource.onerror = function(event) {
                console.log('EventSource error, reconnecting...');
                setTimeout(startEventSource, 5000);
            };
        }
        
        function toggleAutoUpdate() {
            autoUpdateEnabled = !autoUpdateEnabled;
            const btn = document.getElementById('autoUpdateBtn');
            
            if (autoUpdateEnabled) {
                btn.textContent = 'Disable Auto-Update';
                btn.className = 'btn btn-secondary';
                startEventSource();
                document.querySelector('.live-indicator').style.display = 'block';
            } else {
                btn.textContent = 'Enable Auto-Update';
                btn.className = 'btn';
                if (eventSource) {
                    eventSource.close();
                }
                document.querySelector('.live-indicator').style.display = 'none';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadChart();
            if (autoUpdateEnabled) {
                startEventSource();
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
