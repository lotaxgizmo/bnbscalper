<!DOCTYPE html>
<html>
<head>
    <title>BNB Price Difference Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body style="background-color: #1a1a1a; color: #ffffff;">
    <div style="width: 90%; margin: 20px auto;">
        <canvas id="priceChart"></canvas>
        <div id="summary" style="margin-top: 20px; font-family: monospace;"></div>
    </div>

    <script type="module">
        import { getCandles } from './binance.js';
        import { time, symbol, limit } from './config.js';

        async function updateChart() {
            const candles = await getCandles(symbol, time, limit);
            
            const data = candles.map(c => ({
                time: new Date(c.time).toLocaleTimeString(),
                diff: ((c.high - c.low) / c.low * 100).toFixed(2),
                high: parseFloat(c.high),
                low: parseFloat(c.low)
            }));

            const times = data.map(d => d.time);
            const diffs = data.map(d => parseFloat(d.diff));

            // Calculate averages
            const sortedDiffs = [...diffs].sort((a, b) => a - b);
            const avgDiff = (diffs.reduce((sum, val) => sum + val, 0) / diffs.length).toFixed(2);
            const mediumAvg = sortedDiffs[Math.floor(sortedDiffs.length * 0.75)].toFixed(2);
            const highAvg = sortedDiffs[Math.floor(sortedDiffs.length * 0.9)].toFixed(2);

            // Find highest and lowest
            const highest = data.reduce((max, curr) => 
                parseFloat(curr.diff) > parseFloat(max.diff) ? curr : max
            );
            const lowest = data.reduce((min, curr) => 
                parseFloat(curr.diff) < parseFloat(min.diff) ? min : min
            );

            // Calculate total average price
            const totalAvg = (data.reduce((sum, d) => sum + (d.high + d.low) / 2, 0) / data.length).toFixed(2);

            // Update summary
            document.getElementById('summary').innerHTML = 
                `<span style="color: #ff4444"><strong>Highest:</strong> ${highest.diff}% at ${highest.time}</span><br>` +
                `<span style="color: #4444ff"><strong>Lowest:</strong> ${lowest.diff}% at ${lowest.time}</span><br>` +
                `<span style="color: #00ff88"><strong>Average:</strong> ${avgDiff}%</span><br>` +
                `<span style="color: #ffff00"><strong>Medium Avg:</strong> ${mediumAvg}%</span><br>` +
                `<span style="color: #ff0000"><strong>High Avg:</strong> ${highAvg}%</span><br>` +
                `<span style="color: #00ff88"><strong>Total Avg Price:</strong> $${totalAvg}</span>`;

            // Create new chart
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times,
                    datasets: [{
                        label: 'Price Difference %',
                        data: diffs,
                        borderColor: '#00ff88',
                        tension: 0.1,
                        pointBackgroundColor: function(context) {
                            const diff = context.raw;
                            if (diff >= parseFloat(highAvg)) return '#ff0000';
                            if (diff >= parseFloat(mediumAvg)) return '#ffff00';
                            return '#00ff88';
                        },
                        pointRadius: function(context) {
                            const diff = context.raw;
                            if (diff >= parseFloat(highAvg)) return 6;
                            if (diff >= parseFloat(mediumAvg)) return 5;
                            return 3;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        annotation: {
                            annotations: {
                                normalLine: {
                                    type: 'line',
                                    yMin: avgDiff,
                                    yMax: avgDiff,
                                    borderColor: 'rgba(0, 255, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: `Normal ${avgDiff}%`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0, 255, 0, 0.5)',
                                        color: '#ffffff'
                                    }
                                },
                                mediumLine: {
                                    type: 'line',
                                    yMin: mediumAvg,
                                    yMax: mediumAvg,
                                    borderColor: 'rgba(255, 255, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: `Medium ${mediumAvg}%`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 255, 0, 0.5)',
                                        color: '#ffffff'
                                    }
                                },
                                highLine: {
                                    type: 'line',
                                    yMin: highAvg,
                                    yMax: highAvg,
                                    borderColor: 'rgba(255, 0, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: `High ${highAvg}%`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 0, 0, 0.5)',
                                        color: '#ffffff'
                                    }
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'BNB Price High-Low Percentage Difference',
                            color: '#ffffff'
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        y: {
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#ffffff',
                                stepSize: 0.01
                            }
                        }
                    }
                }
            });
        }

        // Update every minute
        updateChart();
        setInterval(updateChart, 60000);
    </script>
</body>
</html>
<html>
<head>
    <title>BNB Price Difference Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body style="background-color: #1a1a1a; color: #ffffff;">
    <div style="text-align: center; margin: 20px;">
        <div id="highLow" style="font-family: Arial; margin-bottom: 20px; color: #ffffff;"></div>
    </div>
    <canvas id="priceChart" width="800" height="400"></canvas>
    <script type="module">
        import { getCandles } from './binance.js';
        import { time, symbol, limit } from './config.js';

        async function updateChart() {
            // Register the annotation plugin
            Chart.register(ChartAnnotation);

            const candles = await getCandles(symbol, time, limit);
            
            const data = candles.map(c => ({
                time: new Date(c.time).toLocaleTimeString(),
                diff: ((c.high - c.low) / c.low * 100).toFixed(2),
                high: parseFloat(c.high),
                low: parseFloat(c.low)
            }));

            const times = data.map(d => d.time);
            const diffs = data.map(d => d.diff);
            
            // Calculate averages
            const sortedDiffs = diffs.map(d => parseFloat(d)).sort((a, b) => a - b);
            const avgDiff = (diffs.reduce((sum, val) => sum + parseFloat(val), 0) / diffs.length).toFixed(2);
            const mediumAvg = sortedDiffs[Math.floor(sortedDiffs.length * 0.75)].toFixed(2);
            const highAvg = sortedDiffs[Math.floor(sortedDiffs.length * 0.9)].toFixed(2);

            // Find highest and lowest
            const highest = data.reduce((max, curr) => 
                parseFloat(curr.diff) > parseFloat(max.diff) ? curr : max
            );
            const lowest = data.reduce((min, curr) => 
                parseFloat(min.diff) > parseFloat(curr.diff) ? curr : min
            );

            // Calculate total average price
            const totalAvg = (data.reduce((sum, d) => sum + ((d.high + d.low) / 2), 0) / data.length).toFixed(2);

            // Update the display
            document.getElementById('highLow').innerHTML = 
                `<span style="color: #ff4444"><strong>Highest:</strong> ${highest.diff}% at ${highest.time}</span> | ` +
                `<span style="color: #4444ff"><strong>Lowest:</strong> ${lowest.diff}% at ${lowest.time}</span> | ` +
                `<span style="color: #aaaaaa"><strong>Avg Diff:</strong> ${avgDiff}%</span> | ` +
                `<span style="color: #00ff88"><strong>Total Avg Price:</strong> $${totalAvg}</span>`;

            const ctx = document.getElementById('priceChart').getContext('2d');

            // Create new chart
            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: times,
                    datasets: [{
                        label: 'Price Difference %',
                        data: diffs,
                        borderColor: '#00ff88',
                        tension: 0.1,
                        pointBackgroundColor: function(context) {
                            const diff = context.raw;
                            if (diff === parseFloat(highest.diff)) return '#ff4444';
                            if (diff === parseFloat(lowest.diff)) return '#4444ff';
                            return '#00ff88';
                        },
                        pointRadius: function(context) {
                            const diff = context.raw;
                            if (diff === parseFloat(highest.diff) || diff === parseFloat(lowest.diff)) return 6;
                            return 3;
                        }
                    }, {
                        label: 'Average Difference',
                        data: Array(times.length).fill(avgDiff),
                        borderColor: '#aaaaaa',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        annotation: {
                            annotations: {
                                normalLine: {
                                    type: 'line',
                                    yMin: avgDiff,
                                    yMax: avgDiff,
                                    borderColor: 'rgba(0, 255, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: `Normal ${avgDiff}%`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(0, 255, 0, 0.5)',
                                        color: '#ffffff'
                                    }
                                },
                                mediumLine: {
                                    type: 'line',
                                    yMin: mediumAvg,
                                    yMax: mediumAvg,
                                    borderColor: 'rgba(255, 255, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: `Medium ${mediumAvg}%`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 255, 0, 0.5)',
                                        color: '#ffffff'
                                    }
                                },
                                highLine: {
                                    type: 'line',
                                    yMin: highAvg,
                                    yMax: highAvg,
                                    borderColor: 'rgba(255, 0, 0, 0.5)',
                                    borderWidth: 2,
                                    label: {
                                        content: `High ${highAvg}%`,
                                        enabled: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 0, 0, 0.5)',
                                        color: '#ffffff'
                                    }
                                }
                            },
                        },
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'BNB Price High-Low Percentage Difference',
                            color: '#ffffff'
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333333'
                            },
                        ticks: {
                            color: '#ffffff'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#333333'
                        },
                        ticks: {
                            color: '#ffffff',
                            stepSize: 0.01
                        },
                        title: {
                            display: true,
                            text: 'Percentage Difference (%)',
                            color: '#ffffff'
                        }
                    }
                }
            }
            });
        }

        // Initial update
        updateChart();

        // Update every minute
        setInterval(updateChart, 60000);
    </script>
</body>
</html>
